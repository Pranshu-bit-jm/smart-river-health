<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Smart River Health — Home</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- Leaflet CSS/JS (map used on separate page) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<link rel="stylesheet" href="style.css">

</head>
<body>
<header class="site-header">
  <div class="brand"><div class="logo">SR</div><div>
    <h1>Smart River Health</h1>
    <div class="tag">Citizen water checks • pH • Temperature • Turbidity</div>
  </div></div>

  <nav class="main-nav">
    <a href="index.html" class="active">Home</a>
    <a href="phchart.html">pH Chart</a>
    <a href="phcare.html">pH Care</a>
    <a href="map.html">World Map</a>
    <a href="details.html">Details</a>
  </nav>
</header>

<main class="layout">
  <section class="left card">
    <h2>Enter water readings</h2>

    <label for="ph">pH (0–14)</label>
    <input id="ph" type="number" step="0.1" min="0" max="14" placeholder="7.2">

    <label for="temp">Temperature (°C)</label>
    <input id="temp" type="number" step="0.1" min="-10" max="60" placeholder="25">

    <label for="turb">Turbidity</label>
    <select id="turb">
      <option value="">Select turbidity</option>
      <option value="low">Low — Clear</option>
      <option value="medium">Medium — Cloudy</option>
      <option value="high">High — Muddy</option>
    </select>

    <div class="controls-row">
      <button id="analyze" class="btn primary">Analyze</button>
      <button id="save" class="btn">Save Reading</button>
      <button id="clear" class="btn ghost">Clear History</button>
    </div>

    <div id="result" class="result card-large" aria-live="polite" style="display:none">
      <div class="score-bubble" id="scoreBubble">100</div>
      <div class="result-meta">
        <div class="status-line"><strong id="statusLabel">Status:</strong> <span id="statusWord">Excellent</span> <span id="statusChip" class="chip good">GOOD</span></div>
        <div id="subscores" class="muted">pH: - • Temp: - • Turbidity: -</div>
        <div id="advice" class="advice">Advice appears here after analysis.</div>
      </div>
    </div>

    <h3>Saved Readings</h3>
    <div class="history card" id="historyWrap">
      <table id="historyTable">
        <thead><tr><th>When</th><th>pH</th><th>Temp</th><th>Turb</th><th>Index</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

  </section>

  <aside class="right">
    <div class="card">
      <h3>Recent Index Chart</h3>
      <canvas id="indexChart" height="180"></canvas>
    </div>

    <div class="card">
      <h3>pH Distribution</h3>
      <canvas id="phBar" height="140"></canvas>
    </div>

    <div class="card">
      <h3>Quick Links</h3>
      <ul class="quick-links">
        <li><a href="phchart.html">pH reference chart</a></li>
        <li><a href="phcare.html">How to neutralize pH</a></li>
        <li><a href="map.html">Explore world samples</a></li>
      </ul>
    </div>

  </aside>
</main>

<footer class="site-footer">
  <div>© 2025 Smart River Health • Built by AquaGuard Innovators</div>
</footer>

<script>
/* ========== Simple, clear index logic (no weights UI) ========== */
(function(){
  // helpers
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function round(v){ return Math.round(v); }

  // scoring subs
  function scorePH(ph){
    // center 7.2 best, ideal window 6.5-8.5
    if (ph >= 6.5 && ph <= 8.5) return 100 - Math.abs(7.2 - ph) * 6; // small penalty inside ideal
    // outside ideal rapid penalty
    const diff = Math.abs(ph - 7.5);
    return clamp(100 - Math.pow(diff,1.5)*10,0,100);
  }
  function scoreTemp(t){
    // best 20-28
    if (t>=20 && t<=28) return 100 - Math.abs(24 - t) * 1.5;
    if (t < 20) return clamp(100 - Math.pow(20 - t,1.2)*6,0,100);
    return clamp(100 - Math.pow(t - 28,1.2)*7,0,100);
  }
  function scoreTurb(turb){
    if (turb === 'low') return 100;
    if (turb === 'medium') return 60;
    if (turb === 'high') return 30;
    return 50;
  }

  // advice mapping (concise but more nuanced)
  const adviceMap = [
    {min:95, text:"Excellent — near-pristine. Keep protecting the catchment."},
    {min:85, text:"Very good — minimal issues. Monitor seasonally."},
    {min:75, text:"Good — small issues; check upstream runoff after heavy rain."},
    {min:65, text:"Fair — slight stress for sensitive species; reduce pollution inputs."},
    {min:55, text:"Moderate — manage sediments and test for nutrients."},
    {min:45, text:"Below ideal — avoid drinking; consider filtration for usage."},
    {min:35, text:"Poor — limit contact; inspect upstream sources and report if needed."},
    {min:25, text:"Very poor — likely pollution; sample and escalate to local authority."},
    {min:0,  text:"Critical — hazardous water. Do not use; urgent cleanup required."}
  ];

  function getAdvice(index){
    for (let i=0;i<adviceMap.length;i++){
      if (index >= adviceMap[i].min) return adviceMap[i].text;
    }
    return "No advice.";
  }

  // DOM
  const phEl = document.getElementById('ph');
  const tempEl = document.getElementById('temp');
  const turbEl = document.getElementById('turb');
  const analyzeBtn = document.getElementById('analyze');
  const saveBtn = document.getElementById('save');
  const clearBtn = document.getElementById('clear');
  const resultDiv = document.getElementById('result');
  const scoreBubble = document.getElementById('scoreBubble');
  const statusWord = document.getElementById('statusWord');
  const statusChip = document.getElementById('statusChip');
  const subscores = document.getElementById('subscores');
  const adviceDiv = document.getElementById('advice');
  const historyTbody = document.querySelector('#historyTable tbody');

  const STORAGE_KEY = 'srh_readings_v2';

  function loadHistory(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch(e){ return []; } }
  function saveHistory(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }

  function renderHistory(){
    const arr = loadHistory();
    historyTbody.innerHTML = '';
    arr.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${new Date(r.ts).toLocaleString()}</td><td>${r.ph}</td><td>${r.temp}</td><td>${r.turb}</td><td>${r.index}</td>`;
      historyTbody.appendChild(tr);
    });
    updateCharts();
  }

  // Chart.js setup
  let indexChart, phBar;
  function setupCharts(){
    const ctx = document.getElementById('indexChart').getContext('2d');
    indexChart = new Chart(ctx, {
      type:'line', data:{labels:[], datasets:[{label:'Index', data:[], fill:true, backgroundColor:'rgba(1,122,153,0.12)', borderColor:'#0177a5'}]},
      options:{scales:{y:{min:0,max:100}}}
    });
    const ctx2 = document.getElementById('phBar').getContext('2d');
    phBar = new Chart(ctx2, {
      type:'bar', data:{labels:[], datasets:[{label:'pH', data:[], backgroundColor:[]}],
      }, options:{scales:{y:{min:0,max:14}}}
    });
  }
  function updateCharts(){
    const arr = loadHistory().slice(0,50);
    const labels = arr.map(a=>new Date(a.ts).toLocaleTimeString());
    const data = arr.map(a=>a.index);
    indexChart.data.labels = labels;
    indexChart.data.datasets[0].data = data;
    indexChart.update();

    phBar.data.labels = labels;
    phBar.data.datasets[0].data = arr.map(a=>a.ph);
    phBar.data.datasets[0].backgroundColor = arr.map(a=>a.index>=80?'rgba(46,125,50,0.8)':(a.index>=50?'rgba(249,168,37,0.8)':'rgba(198,40,40,0.8)'));
    phBar.update();
  }

  function analyze(showUI=true){
    const ph = parseFloat(phEl.value);
    const temp = parseFloat(tempEl.value);
    const turb = turbEl.value;
    if (isNaN(ph) || isNaN(temp) || !turb){ alert('Enter pH, temperature and turbidity.'); return null; }

    const phS = scorePH(ph);
    const tS = scoreTemp(temp);
    const turbS = scoreTurb(turb);
    // weighted (simple fixed weights)
    const idx = clamp(round(phS*0.45 + tS*0.28 + turbS*0.27), 0, 100);

    if (showUI){
      resultDiv.style.display = 'flex';
      scoreBubble.textContent = idx;
      subscores.textContent = `pH: ${Math.round(phS)} • Temp: ${Math.round(tS)} • Turbidity: ${Math.round(turbS)}`;
      const advice = getAdvice(idx);
      adviceDiv.textContent = advice;

      // status
      if (idx >= 80){ statusWord.textContent = 'Excellent'; statusChip.className='chip good'; }
      else if (idx >= 50){ statusWord.textContent = 'Moderate'; statusChip.className='chip warn'; }
      else { statusWord.textContent = 'Poor'; statusChip.className='chip bad'; }
    }

    return {idx,phS,tS,turbS,ph,temp,turb};
  }

  analyzeBtn.addEventListener('click', function(){ analyze(true); });
  saveBtn.addEventListener('click', function(){
    const out = analyze(false);
    if (!out) return;
    const arr = loadHistory();
    arr.unshift({ts:Date.now(), ph:out.ph, temp:out.temp, turb:out.turb, index:out.idx});
    saveHistory(arr);
    renderHistory();
  });
  clearBtn.addEventListener('click', function(){
    if (!confirm('Clear saved readings?')) return;
    localStorage.removeItem(STORAGE_KEY);
    renderHistory();
  });

  // init
  setupCharts();
  renderHistory();

  // prefill example values
  phEl.value = 7.2; tempEl.value = 25; turbEl.value = 'low';
})();
</script>

</body>
</html>
